import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { Settings, Users, Calendar, Home as HomeIcon, LayoutDashboard, Plus, Camera, Image, FileText, Edit } from "lucide-react";
import Header from "@/components/Header";
import UpcomingEvents from "@/components/UpcomingEvents";
import { AgendaView } from "@/components/AgendaView";
import { AddMemberDialog } from "@/components/AddMemberDialog";
import { useToast } from "@/hooks/use-toast";

// Simulación de Drawers (Asegúrate de tener estos archivos o créalos básicos)
import { ManualEventDrawer } from "@/components/ManualEventDrawer";
import { UploadDocumentDrawer } from "@/components/UploadDocumentDrawer";

const Index = () => {
  const [activeTab, setActiveTab] = useState("home");
  const [familyMembers, setFamilyMembers] = useState<any[]>([]);
  const [events, setEvents] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  
  // ESTADOS PARA EL FAB RADIAL Y DRAWERS
  const [isOpen, setIsOpen] = useState(false);
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const [dialogType, setDialogType] = useState('manual');

  const { toast } = useToast();

  const fetchAllData = async () => {
    const { data: profiles } = await supabase.from('profiles').select('*');
    const { data: eventData } = await supabase.from('events').select('*').order('start_time', { ascending: true });
    setFamilyMembers(profiles || []);
    setEvents(eventData || []);
    setLoading(false);
  };

  useEffect(() => {
    fetchAllData();
  }, []);

  const handleSubButtonClick = (type: string) => {
    setDialogType(type);
    setIsDrawerOpen(true);
    setIsOpen(false);
  };

  return (
    <div className="relative min-h-screen w-full overflow-hidden">
      {/* 1. EL FONDO WAVY (Debe ser el primer elemento con z-index bajo) */}
      <div className="wave-bg" />

      {/* 2. CONTENIDO PRINCIPAL */}
      <div className="relative z-10 pb-32">
        <Header />
        
        <main className="container mx-auto px-4 pt-4 max-w-md">
          {activeTab === "home" && (
            <div className="space-y-6 animate-in fade-in duration-700">
              <div className="glass-card p-6">
                <h2 className="text-xl font-bold font-nunito mb-2">Santuario de Calma</h2>
                <p className="text-sm opacity-80 leading-relaxed">
                  {events.length > 0 ? `Tienes ${events.length} tareas en el nido.` : "Todo está en paz por ahora."}
                </p>
              </div>
              <UpcomingEvents events={events.slice(0, 3)} />
            </div>
          )}

          {activeTab === "agenda" && <div className="animate-in slide-in-from-right-4"><AgendaView /></div>}

          {activeTab === "family" && (
            <div className="space-y-6 animate-in slide-in-from-bottom-4">
              <div className="flex justify-between items-center px-2">
                <h2 className="text-2xl font-bold font-nunito">Familia</h2>
                <AddMemberDialog onMemberAdded={fetchAllData} />
              </div>
              <div className="grid grid-cols-2 gap-4">
                {familyMembers.map((m) => (
                  <div key={m.id} className="glass-card p-4 flex flex-col items-center">
                    <div className="w-12 h-12 rounded-full bg-kidus-blue/20 flex items-center justify-center mb-2 font-bold text-kidus-blue">
                      {m.display_name?.charAt(0)}
                    </div>
                    <span className="font-bold text-sm">{m.display_name}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </main>
      </div>

      {/* 3. FAB RADIAL (Basado en tu CSS) */}
      <div className="fab-radial-container">
        <button className={`fab-sub-button ${isOpen ? 'visible' : ''}`} onClick={() => handleSubButtonClick('camera')}>
          <Camera className="w-5 h-5" />
        </button>
        <button className={`fab-sub-button ${isOpen ? 'visible' : ''}`} onClick={() => handleSubButtonClick('gallery')}>
          <Image className="w-5 h-5" />
        </button>
        <button className={`fab-sub-button ${isOpen ? 'visible' : ''}`} onClick={() => handleSubButtonClick('upload')}>
          <FileText className="w-5 h-5" />
        </button>
        <button className={`fab-sub-button ${isOpen ? 'visible' : ''}`} onClick={() => handleSubButtonClick('manual')}>
          <Edit className="w-5 h-5" />
        </button>

        <button className={`fab-main-button ${isOpen ? 'open' : ''}`} onClick={() => setIsOpen(!isOpen)}>
          <Plus className="w-8 h-8" />
        </button>
      </div>

      {/* 4. NAV INFERIOR */}
      <nav className="fixed bottom-0 left-0 right-0 px-6 py-4 flex justify-around items-center backdrop-blur-3xl bg-white/50 border-t border-white/20 z-40 rounded-t-[40px]">
        <button onClick={() => setActiveTab("home")} className={`flex flex-col items-center ${activeTab === "home" ? "text-kidus-blue" : "text-gray-400"}`}>
          <HomeIcon className="w-6 h-6" />
        </button>
        <button onClick={() => setActiveTab("agenda")} className={`flex flex-col items-center ${activeTab === "agenda" ? "text-kidus-blue" : "text-gray-400"}`}>
          <Calendar className="w-6 h-6" />
        </button>
        <button onClick={() => setActiveTab("family")} className={`flex flex-col items-center ${activeTab === "family" ? "text-kidus-blue" : "text-gray-400"}`}>
          <Users className="w-6 h-6" />
        </button>
      </nav>

      {/* 5. DRAWER (El formulario que sube) */}
      {isDrawerOpen && (
        <div className="fixed inset-0 z-[100] flex items-end justify-center pointer-events-none">
          <div className="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto" onClick={() => setIsDrawerOpen(false)} />
          <div className="w-full max-w-md pointer-events-auto animate-in slide-in-from-bottom duration-500">
             {dialogType === 'manual' ? (
               <ManualEventDrawer onClose={() => setIsDrawerOpen(false)} onEventAdded={fetchAllData} members={familyMembers} />
             ) : (
               <UploadDocumentDrawer isOpen={isDrawerOpen} onClose={() => setIsDrawerOpen(false)} onEventAdded={fetchAllData} members={familyMembers} />
             )}
          </div>
        </div>
      )}
    </div>
  );
};

export default Index;
